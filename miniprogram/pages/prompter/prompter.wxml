<view class="page-wrapper">
  <!-- Camera View (Background) -->
  <camera 
    wx:if="{{isRecording}}" 
    class="camera-view" 
    device-position="{{devicePosition}}" 
    flash="off"
    resolution="high"
    bindinitdone="onCameraReady"
    style="{{cameraStyle}}"
  ></camera>

  <view class="container-prompter" style="background-color: {{isRecording ? 'transparent' : bgColor}};">
  
  <!-- Header -->
  <view class="header {{isLandscape ? 'header-landscape' : ''}}" style="padding-top: {{isLandscape ? 5 : statusBarHeight}}px; opacity: {{isRunning || uiHidden ? 0 : 1}}; pointer-events: {{isRunning || uiHidden ? 'none' : 'auto'}};">
    <view class="left-group">
      <view class="icon-btn" catchtap="goBack">
        <text class="icon">←</text>
      </view>
      <view class="icon-btn" catchtap="toggleSettings">
        <text class="icon">⚙️</text>
      </view>
    </view>
    
    <view class="mode-switch">
      <view class="mode-item {{mode === 'basic' ? 'active' : ''}}" bindtap="switchMode" data-mode="basic">基础</view>
      <view class="mode-item {{mode === 'smart' ? 'active' : ''}}" bindtap="switchMode" data-mode="smart">跟随</view>
    </view>

    <view class="right-placeholder"></view>
  </view>

  <!-- Focus Line Indicator -->
  <view class="focus-line-container {{isLandscape ? 'focus-line-container-landscape' : ''}}" style="top: {{baselinePercent}}%;">
    <view class="focus-arrow">▶</view>
    <view class="focus-line"></view>
  </view>

  <!-- Focus Masks (Dimming Effect) -->
  <view wx:if="{{focusEnabled}}" class="focus-mask-top" style="height: {{baselinePercent - 10}}%; background: linear-gradient(to bottom, {{bgColor}} 30%, transparent 100%);"></view>
  <view wx:if="{{focusEnabled}}" class="focus-mask-bottom" style="top: {{baselinePercent + 10}}%; height: {{100 - (baselinePercent + 10)}}%; background: linear-gradient(to top, {{bgColor}} 30%, transparent 100%);"></view>

  <!-- Prompter Text Area -->
  <view 
    class="prompter-viewport"
    bindtouchstart="onTouchStart"
    bindtouchmove="onTouchMove"
    bindtouchend="onTouchEnd"
    bindtap="onScreenTap"
  >
    <view 
      class="prompter-content"
      style="transform: translateY({{offsetY}}px); transition: {{transitionStyle}};"
    >
      <!-- Dynamic Padding based on Baseline -->
      <view class="padding-space" style="height: {{baselinePercent}}vh;"></view>
      
      <view class="text-content" style="font-size: {{fontSize}}px; line-height: {{lineHeight}}; letter-spacing: {{letterSpacing}}px; text-align: {{textAlign}}; color: {{fontColor}};">
        <text>{{content}}</text>
      </view>

      <view class="padding-space" style="height: {{100 - baselinePercent}}vh;"></view>
    </view>
  </view>

  <!-- AI Status Indicator (Fixed at Bottom) -->
  <view wx:if="{{mode === 'smart' && isRunning}}" class="ai-feedback-fixed {{isLandscape ? 'ai-feedback-fixed-landscape' : ''}}">
    <text class="ai-status">🎙️ AI 正在聆听...</text>
  </view>

  <!-- Countdown Overlay -->
  <view class="countdown-overlay {{isLandscape ? 'countdown-overlay-landscape' : ''}}" wx:if="{{countdown > 0}}">
    <text class="countdown-text">{{countdown}}</text>
  </view>

  <!-- Bottom Controls -->
  <view class="controls" wx:if="{{!isRunning && countdown === 0 && !uiHidden}}">
    <block wx:if="{{mode === 'basic'}}">
      <view class="btn-play-round" bindtap="startBasicScroll">
        <view class="icon-play"></view>
      </view>
    </block>

    <block wx:if="{{mode === 'smart'}}">
      <view class="btn-play-round btn-play-ai" bindtap="startSmartFollow">
        <view class="icon-play"></view>
      </view>
    </block>
  </view>

  <!-- Settings Panel -->
  <view class="settings-panel {{isLandscape ? 'settings-panel-landscape' : ''}} {{showSettings ? 'settings-panel-show' : ''}}">
    <!-- Live Preview -->
    <view class="settings-preview" style="background-color: {{bgColor}}; color: {{fontColor}}; font-size: {{fontSize}}px; line-height: {{lineHeight}}; letter-spacing: {{letterSpacing}}px; text-align: {{textAlign}};">
      <view class="preview-text-line">这是预览文字</view>
      <view class="preview-text-line">实时查看效果</view>
    </view>
    
    <!-- Tabs -->
    <view class="settings-tabs">
      <view class="settings-tab-item {{activeSettingsTab === 'display' ? 'active' : ''}}" bindtap="switchSettingsTab" data-tab="display">显示</view>
      <view class="settings-tab-item {{activeSettingsTab === 'scroll' ? 'active' : ''}}" bindtap="switchSettingsTab" data-tab="scroll">滚动</view>
      <view class="settings-tab-item {{activeSettingsTab === 'color' ? 'active' : ''}}" bindtap="switchSettingsTab" data-tab="color">颜色</view>
      <view class="settings-tab-item {{activeSettingsTab === 'advanced' ? 'active' : ''}}" bindtap="switchSettingsTab" data-tab="advanced">高级</view>
    </view>

    <scroll-view scroll-y="true" class="settings-content">
      <!-- Display Settings -->
      <view wx:if="{{activeSettingsTab === 'display'}}">
        <view class="setting-group">
          <view class="setting-item">
            <text>字号 ({{fontSize}}px)</text>
            <slider min="20" max="80" value="{{fontSize}}" bindchange="onFontSizeChange" />
          </view>
          <view class="setting-item">
            <text>行间距 ({{lineHeight}})</text>
            <slider min="1.0" max="3.0" step="0.1" value="{{lineHeight}}" bindchange="onLineHeightChange" />
          </view>
          <view class="setting-item">
            <text>字间距 ({{letterSpacing}}px)</text>
            <slider min="0" max="10" step="1" value="{{letterSpacing}}" bindchange="onLetterSpacingChange" />
          </view>
          <view class="setting-item">
            <text>对齐方式</text>
            <view class="align-options">
              <view class="align-btn {{textAlign === 'left' ? 'active' : ''}}" bindtap="onTextAlignChange" data-align="left">
                <view class="icon-align icon-align-left"></view>
              </view>
              <view class="align-btn {{textAlign === 'center' ? 'active' : ''}}" bindtap="onTextAlignChange" data-align="center">
                <view class="icon-align icon-align-center"></view>
              </view>
              <view class="align-btn {{textAlign === 'right' ? 'active' : ''}}" bindtap="onTextAlignChange" data-align="right">
                <view class="icon-align icon-align-right"></view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- Scroll Settings -->
      <view wx:if="{{activeSettingsTab === 'scroll' && mode === 'basic'}}">
        <view class="setting-group">
          <view class="setting-item">
            <text>开始倒计时 ({{countdownDuration}}秒)</text>
            <slider min="0" max="10" value="{{countdownDuration}}" bindchange="onCountdownDurationChange" />
          </view>
          <view class="setting-item">
            <text>每分钟字数 ({{wordsPerMinute}})</text>
            <slider min="60" max="400" value="{{wordsPerMinute}}" bindchange="onWpmChange" />
          </view>
        </view>
         <view wx:if="{{mode !== 'basic'}}" class="settings-placeholder">
          <text>滚动设置仅在“基础”模式下可用</text>
        </view>
      </view>

      <!-- Color Settings -->
      <view wx:if="{{activeSettingsTab === 'color'}}">
        <view class="setting-group">
          <view class="setting-title">文字颜色</view>
          <view class="color-options-grid">
            <view class="color-circle-wrapper" bindtap="setFontColor" data-color="#FFFFFF"><view class="color-circle" style="background:#FFFFFF;"></view></view>
            <view class="color-circle-wrapper" bindtap="setFontColor" data-color="#000000"><view class="color-circle" style="background:#000000;"></view></view>
            <view class="color-circle-wrapper" bindtap="setFontColor" data-color="#FFD700"><view class="color-circle" style="background:#FFD700;"></view></view>
            <view class="color-circle-wrapper" bindtap="setFontColor" data-color="#1E90FF"><view class="color-circle" style="background:#1E90FF;"></view></view>
            <view class="color-circle-wrapper" bindtap="setFontColor" data-color="#FF4500"><view class="color-circle" style="background:#FF4500;"></view></view>
          </view>
        </view>
        <view class="setting-group">
          <view class="setting-title">背景颜色</view>
          <view class="color-options-grid">
            <view class="color-circle-wrapper" bindtap="setBgColor" data-color="#000000"><view class="color-circle" style="background:#000000;"></view></view>
            <view class="color-circle-wrapper" bindtap="setBgColor" data-color="#FFFFFF"><view class="color-circle" style="background:#FFFFFF; border: 1px solid #eee;"></view></view>
            <view class="color-circle-wrapper" bindtap="setBgColor" data-color="#00B140"><view class="color-circle" style="background:#00B140;"></view></view>
             <view class="color-circle-wrapper" bindtap="setBgColor" data-color="#191970"><view class="color-circle" style="background:#191970;"></view></view>
            <view class="color-circle-wrapper" bindtap="setBgColor" data-color="#808080"><view class="color-circle" style="background:#808080;"></view></view>
          </view>
        </view>
      </view>

      <!-- Advanced Settings -->
      <view wx:if="{{activeSettingsTab === 'advanced'}}">
        <view class="setting-group">
          <view class="setting-item">
            <text>基准线位置 ({{baselinePercent}}%)</text>
            <slider min="20" max="80" step="5" value="{{baselinePercent}}" bindchange="onBaselineChange" />
          </view>
          <view class="setting-item switch-item">
            <text>台本聚焦模式</text>
            <switch checked="{{focusEnabled}}" bindchange="onFocusToggle" />
          </view>
        </view>
      </view>

    </scroll-view>

    <button class="btn-close-settings" bindtap="toggleSettings">完成</button>
  </view>
</view>

<!-- Recording Controls -->
<view class="record-controls {{isLandscape ? 'record-controls-landscape' : ''}}" wx:if="{{isRecording}}">
  <view class="rc-placeholder"></view>
  <view class="rc-record-wrapper" bindtap="toggleRecord">
    <view class="rc-record-btn {{recordStatus}}"></view>
  </view>
  <view class="rc-switch-camera" bindtap="switchCamera">
    <image class="rc-switch-icon-img" src="../../images/camera-switch.svg" />
  </view>
</view>
</view>